# 重构：复制的观察数据

## 问题

在负责 GUI 的类中存储了领域数据吗？

## 解决方案

那么最好将数据分离到单独的类中，确保领域类和 GUI 之间有连接和同步。

### 重构前
![Duplicate Observed Data - Before](link-to-image-before)

### 重构后
![Duplicate Observed Data - After](link-to-image-after)

## 为何要进行重构

您希望为相同数据拥有多个界面视图（例如，您既有桌面应用程序又有移动应用程序）。如果未将 GUI 与领域分离，将很难避免代码重复和大量错误。

## 优势

您在业务逻辑类和表示类之间分离了责任（参见单一职责原则），从而使程序更易读和易懂。

如果需要添加新的界面视图，只需创建新的表示类；您无需触及业务逻辑的代码（参见开闭原则）。

现在，不同的人可以同时处理业务逻辑和用户界面。

## 不适用场景

这种经典形式上使用 Observer 模板执行的重构技术在 Web 应用中不适用，因为在对 Web 服务器的查询之间，所有类都会被重新创建。

尽管如此，将业务逻辑提取到单独的类中的一般原则同样适用于 Web 应用。但这将根据系统设计使用不同的重构技术来实现。

## 如何进行重构

1. 在 GUI 类中隐藏对领域数据的直接访问。最好使用“自我封装字段”进行此操作。因此，您创建这些数据的 getter 和 setter。

2. 在 GUI 类事件的处理程序中，使用 setter 设置新的字段值。这将使您将这些值传递给关联的领域对象。

3. 创建一个领域类，并从 GUI 类复制必要的字段到领域类。为所有这些字段创建 getter 和 setter。

4. 为这两个类创建一个观察者模式：

   - 在领域类中，创建一个用于存储观察者对象（GUI 对象）的数组，以及用于注册、删除和通知它们的方法。
   
   - 在 GUI 类中，创建一个用于存储对领域类的引用的字段，以及 `update()` 方法，该方法将对对象的更改做出反应并更新 GUI 类中字段的值。请注意，值的更新应直接在方法中进行，以避免递归。

5. 在 GUI 类的构造函数中，创建领域类的实例并将其保存在您创建的字段中。在领域对象中注册 GUI 对象作为观察者。

6. 在领域类字段的 setter 中，调用通知观察者的方法（换句话说，在 GUI 类中进行更新的方法），以便将新值传递给 GUI。

7. 更改 GUI 类字段的 setter，使其直接在领域对象中设置新值。请注意确保不要通过领域类的 setter 设置值，否则会导致无限递归。